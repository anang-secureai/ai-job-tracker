<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin — AI Job Loss Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="admin-body">

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <img class="logo-blend" src="/assets/the-alliance-logo-white-1600.png" alt="The Alliance for Secure AI" />
    <h1>AI Job Tracker — Admin</h1>
    <form id="loginForm">
      <input type="password" id="loginPassword" placeholder="Enter admin password" autocomplete="current-password" />
      <button type="submit" class="btn btn-primary" style="width:100%">Sign in</button>
    </form>
    <p class="login-error" id="loginError"></p>
  </div>
</div>

<!-- App -->
<div class="admin-app" id="app">
  <nav class="topbar">
    <div class="topbar-left">
      <img class="logo-blend" src="/assets/the-alliance-shield-white-256.png" alt="" />
      <h1>AI Job Tracker Admin</h1>
    </div>
    <div class="topbar-right">
      <a href="/" class="btn btn-sm" target="_blank">View Dashboard ↗</a>
      <button class="btn btn-sm btn-danger" id="logoutBtn">Sign out</button>
    </div>
  </nav>

  <div class="container">
    <div class="stats-bar" id="statsBar">
      <div class="stat-chip"><strong id="statTotal">0</strong> total reports</div>
      <div class="stat-chip"><strong id="statPublished">0</strong> published</div>
      <div class="stat-chip"><strong id="statDraft">0</strong> drafts</div>
    </div>

    <div class="table-section">
      <div class="table-header">
        <h2>All Reports</h2>
        <button class="btn btn-primary" id="addBtn">+ Add Report</button>
      </div>
      <div style="overflow-x:auto">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Published</th>
              <th>Date</th>
              <th>Company</th>
              <th>Jobs Lost</th>
              <th>Attribution</th>
              <th>Industry</th>
              <th>Source</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="reportsList"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h2 id="modalTitle">Add Report</h2>
    <form id="reportForm">
      <input type="hidden" id="fId" />
      <div class="form-grid">
        <div class="form-group">
          <label for="fDate">Date *</label>
          <input type="date" id="fDate" required />
        </div>
        <div class="form-group">
          <label for="fCompany">Company *</label>
          <input type="text" id="fCompany" required placeholder="e.g. Amazon" />
        </div>
        <div class="form-group">
          <label for="fJobsLost">Jobs Lost *</label>
          <input type="number" id="fJobsLost" required min="1" placeholder="e.g. 14000" />
        </div>
        <div class="form-group">
          <label for="fAttribution">AI Attribution *</label>
          <select id="fAttribution">
            <option value="EXPLICIT">EXPLICIT — company cited AI</option>
            <option value="BLAMED" selected>BLAMED — reporting cites AI</option>
            <option value="MIXED">MIXED — AI + other factors</option>
          </select>
        </div>
        <div class="form-group">
          <label for="fIndustry">Industry</label>
          <input type="text" id="fIndustry" placeholder="e.g. Technology" />
        </div>
        <div class="form-group">
          <label for="fRegion">Region</label>
          <select id="fRegion">
            <option value="US">US</option>
            <option value="INTL">International</option>
            <option value="GLOBAL" selected>Global</option>
          </select>
        </div>
        <div class="form-group">
          <label for="fCountry">Country</label>
          <input type="text" id="fCountry" placeholder="e.g. United States" />
        </div>
        <div class="form-group">
          <label for="fWorkforce">Total Workforce</label>
          <input type="number" id="fWorkforce" min="0" placeholder="optional" />
        </div>
        <div class="form-group">
          <label for="fSourceLabel">Source</label>
          <input type="text" id="fSourceLabel" placeholder="e.g. AP, CNBC, Reuters" />
        </div>
        <div class="form-group">
          <label for="fStockDelta">Stock Δ %</label>
          <input type="number" id="fStockDelta" step="0.01" placeholder="optional" />
        </div>
        <div class="form-group full">
          <label for="fSourceUrl">Source URL</label>
          <input type="url" id="fSourceUrl" placeholder="https://..." />
        </div>
        <div class="form-group">
          <div class="form-row-check">
            <input type="checkbox" id="fEstimate" />
            <label for="fEstimate">Number is an estimate</label>
          </div>
        </div>
        <div class="form-group">
          <div class="form-row-check">
            <input type="checkbox" id="fInclude" />
            <label for="fInclude">Publish to dashboard</label>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" id="cancelBtn">Cancel</button>
        <button type="submit" class="btn btn-primary" id="saveBtn">Save Report</button>
      </div>
    </form>
  </div>
</div>

<div class="toast-container" id="toasts"></div>

<script>
const $=id=>document.getElementById(id);
const dateFmt=d=>d?new Date(d+"T00:00:00").toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"—";
const numFmt=new Intl.NumberFormat("en-US");
let reports=[];

// ── Auth ───
async function checkAuth(){try{const r=await fetch("/api/auth/check");const d=await r.json();if(d.authenticated){showApp();return}}catch{}showLogin()}
function showLogin(){$("loginScreen").style.display="flex";$("app").classList.remove("active")}
function showApp(){$("loginScreen").style.display="none";$("app").classList.add("active");loadReports()}

$("loginForm").addEventListener("submit",async e=>{e.preventDefault();$("loginError").textContent="";try{const r=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:$("loginPassword").value})});const d=await r.json();if(d.ok)showApp();else $("loginError").textContent=d.error||"Login failed"}catch{$("loginError").textContent="Connection error"}});
$("logoutBtn").addEventListener("click",async()=>{await fetch("/api/logout",{method:"POST"});showLogin();$("loginPassword").value=""});

// ── Load & Render ───
async function loadReports(){try{const r=await fetch("/api/admin/reports");if(r.status===401){showLogin();return}const d=await r.json();reports=d.reports||[];renderStats(d.stats);renderTable()}catch{toast("Failed to load reports",true)}}
function renderStats(s){if(!s)return;$("statTotal").textContent=s.total;$("statPublished").textContent=s.published;$("statDraft").textContent=s.draft}
function renderTable(){const tb=$("reportsList");if(!reports.length){tb.innerHTML='<tr><td colspan="8" class="empty-state">No reports yet. Click "Add Report" to get started.</td></tr>';return}tb.innerHTML=reports.map(r=>{const attr=(r.aiAttribution||"MIXED").toLowerCase();const tagClass=attr==="explicit"?"explicit":attr==="blamed"?"blamed":"mixed";const srcDomain=r.sourceUrl?(()=>{try{return new URL(r.sourceUrl).hostname.replace("www.","")}catch{return""}})():"";return `<tr data-id="${r.id}"><td><button class="toggle-track ${r.include?"on":""}" onclick="togglePub(${r.id})" title="${r.include?"Published":"Draft"}"><span class="toggle-knob"></span></button></td><td style="white-space:nowrap">${dateFmt(r.date)}</td><td><strong>${esc(r.company)}</strong></td><td>${r.estimate?"~":""}${numFmt.format(r.jobsLost)}</td><td><span class="attr-tag ${tagClass}">${esc(attr)}</span></td><td>${esc(r.industry||"")}</td><td>${r.sourceUrl?`<a href="${esc(r.sourceUrl)}" target="_blank" rel="noopener" class="source-link">${esc(r.sourceLabel||srcDomain||"link")}</a>`:esc(r.sourceLabel||"—")}</td><td style="text-align:right;white-space:nowrap"><button class="btn btn-sm btn-icon" onclick="editReport(${r.id})" title="Edit">✎</button> <button class="btn btn-sm btn-icon btn-danger" onclick="deleteReport(${r.id})" title="Delete">✕</button></td></tr>`}).join("")}

// ── Toggle ───
async function togglePub(id){try{const r=await fetch(`/api/admin/reports/${id}/toggle`,{method:"PATCH"});if(r.status===401){showLogin();return}const d=await r.json();if(d.ok){const idx=reports.findIndex(x=>x.id===id);if(idx>=0)reports[idx]=d.report;renderTable();toast(d.report.include?"Published":"Unpublished");refreshStats()}}catch{toast("Toggle failed",true)}}
window.togglePub=togglePub;
async function refreshStats(){try{const r=await fetch("/api/admin/reports");const d=await r.json();renderStats(d.stats)}catch{}}

// ── Modal ───
function openModal(report){$("modalTitle").textContent=report?"Edit Report":"Add Report";$("saveBtn").textContent=report?"Update Report":"Save Report";$("fId").value=report?report.id:"";$("fDate").value=report?report.date:new Date().toISOString().slice(0,10);$("fCompany").value=report?report.company:"";$("fJobsLost").value=report?report.jobsLost:"";$("fAttribution").value=report?report.aiAttribution:"BLAMED";$("fIndustry").value=report?report.industry||"":"";$("fRegion").value=report?report.region:"GLOBAL";$("fCountry").value=report?report.country||"":"";$("fWorkforce").value=report?(report.workforce||""):"";$("fSourceLabel").value=report?report.sourceLabel||"":"";$("fSourceUrl").value=report?report.sourceUrl||"":"";$("fStockDelta").value=report?(report.stockDeltaPct??""):"";$("fEstimate").checked=report?report.estimate:false;$("fInclude").checked=report?report.include:false;$("modal").classList.add("open");$("fCompany").focus()}
function closeModal(){$("modal").classList.remove("open")}
$("addBtn").addEventListener("click",()=>openModal(null));
$("cancelBtn").addEventListener("click",closeModal);
$("modal").addEventListener("click",e=>{if(e.target===$("modal"))closeModal()});
document.addEventListener("keydown",e=>{if(e.key==="Escape")closeModal()});
window.editReport=function(id){const r=reports.find(x=>x.id===id);if(r)openModal(r)};

// ── Save ───
$("reportForm").addEventListener("submit",async e=>{e.preventDefault();const id=$("fId").value;const body={date:$("fDate").value,company:$("fCompany").value,jobs_lost:$("fJobsLost").value,ai_attribution:$("fAttribution").value,industry:$("fIndustry").value||"Unknown",region:$("fRegion").value,country:$("fCountry").value||"Global",workforce:$("fWorkforce").value||0,source_label:$("fSourceLabel").value,source_url:$("fSourceUrl").value,stock_delta_pct:$("fStockDelta").value||null,estimate:$("fEstimate").checked,include:$("fInclude").checked,loss_type:"NEW"};try{const method=id?"PUT":"POST";const url=id?`/api/admin/reports/${id}`:"/api/admin/reports";const r=await fetch(url,{method,headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});if(r.status===401){showLogin();return}const d=await r.json();if(d.ok){closeModal();toast(id?"Report updated":"Report added");loadReports()}else toast(d.error||"Save failed",true)}catch{toast("Save failed — connection error",true)}});

// ── Delete ───
window.deleteReport=async function(id){const r=reports.find(x=>x.id===id);if(!confirm(`Delete "${r?.company||"this report"}"? This cannot be undone.`))return;try{const resp=await fetch(`/api/admin/reports/${id}`,{method:"DELETE"});if(resp.status===401){showLogin();return}const d=await resp.json();if(d.ok){toast("Deleted");loadReports()}else toast("Delete failed",true)}catch{toast("Delete failed",true)}};

// ── Toast ───
function toast(msg,err){const t=document.createElement("div");t.className="toast"+(err?" error":"");t.textContent=msg;$("toasts").appendChild(t);setTimeout(()=>{t.style.opacity="0";setTimeout(()=>t.remove(),300)},2800)}

function esc(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}

checkAuth();
</script>
</body>
</html>
