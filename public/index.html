<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Job Loss Tracker — The Alliance for Secure AI</title>
  <meta name="description" content="Tracking AI-linked job losses since January 2025. A public-interest dashboard by The Alliance for Secure AI." />
  <meta property="og:title" content="AI Job Loss Tracker" />
  <meta property="og:description" content="Tracking AI-linked job losses since January 2025." />
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="dash-body">

<!-- Dark header band — matches corporate site -->
<header class="site-header" role="banner">
  <div class="wrap">
    <div class="brand-logo logo-mask"
         style="--mask-img:url(/assets/the-alliance-logo-white-1600.png)"
         role="img" aria-label="The Alliance for Secure AI"></div>
    <div class="brand-badge"><span class="dot" aria-hidden="true"></span> AI Job Loss Tracker</div>
  </div>
</header>

<main>
  <!-- Hero — description + chart -->
  <section class="hero">
    <div class="page">
      <div class="hero-grid">
        <div class="hero-copy">
          <p class="eyebrow">U.S. + Global Monitor</p>
          <h1>AI-linked job losses since early 2025</h1>
          <p class="subtitle">Newly reported layoffs where AI is either explicitly cited or credibly blamed as a material factor. Reporting window starts January&nbsp;1,&nbsp;2025.</p>
          <p class="last-updated" id="lastUpdated"></p>
        </div>
        <aside class="trend-panel" aria-labelledby="trendHeading">
          <p class="trend-kicker">Trendline</p>
          <h3 id="trendHeading">Cumulative AI job losses</h3>
          <canvas id="monthlyLossChart" role="img" aria-label="Cumulative AI job losses chart"></canvas>
          <p id="monthlyLossSummary" class="trend-summary">Loading...</p>
        </aside>
      </div>
    </div>
  </section>

  <!-- Counter hero — dark band with headline + number + pace -->
  <section class="counter-section" aria-labelledby="counter-heading">
    <div class="counter-inner">
      <div class="counter-grid">
        <div class="counter-left">
          <p class="counter-label" id="counter-heading">Total AI-linked job losses</p>
          <div class="counter-number" id="counterNumber" aria-live="polite">0</div>
          <p class="counter-asof" id="asOfText"></p>
        </div>
        <div class="pace-box" id="paceBox">
          <p class="pace-label">This month's pace</p>
          <p class="pace-number" id="paceNumber">—</p>
          <p class="pace-delta" id="paceDelta"></p>
        </div>
      </div>
    </div>
  </section>


  <!-- Reports table -->
  <section class="reports-section">
    <div class="reports-wrap">
      <div class="section-head">
        <h2>Reported layoffs</h2>
        <span class="count-badge" id="tableBadge"></span>
      </div>
      <div class="table-card">
        <div class="table-wrap">
          <table>
            <thead><tr><th scope="col">Company</th><th scope="col">Jobs lost</th><th scope="col">Industry</th><th scope="col">Running total</th><th scope="col">Workforce %</th></tr></thead>
            <tbody id="tableBody"><tr><td colspan="5" class="loading-state"><div class="spinner"></div><br/>Loading...</td></tr></tbody>
          </table>
        </div>
        <div class="mobile-cards" id="mobileCards"><div class="loading-state"><div class="spinner"></div><br/>Loading...</div></div>
      </div>
    </div>
  </section>

  <!-- Methodology -->
  <section class="method-section">
    <div class="method-wrap">
      <details class="method">
        <summary>Counting methodology</summary>
        <div class="method-body">
          <p><strong>Included:</strong> First-time layoffs where AI was a material factor — either explicitly cited by the company, or identified by credible reporting as a primary driver. <strong>Excluded:</strong> Restated totals, duplicate announcements, and layoffs attributed solely to non-AI factors.</p>
        </div>
      </details>
    </div>
  </section>
</main>

<footer class="site-footer" role="contentinfo">
  <div class="footer-inner">
    <div class="footer-logo logo-mask"
         style="--mask-img:url(/assets/the-alliance-logo-white-1600.png)"
         role="img" aria-label="The Alliance for Secure AI"></div>
    <p>A public-interest project by <a href="https://secureainow.org" target="_blank" rel="noopener">The Alliance for Secure AI</a>. Data sourced from AP, Reuters, CNBC, and other major outlets.</p>
  </div>
</footer>

<script>
const BASELINE = new Date(2025, 0, 1);
const C_TYPES = new Set(["NEW"]);
const C_ATTR = new Set(["EXPLICIT", "BLAMED", "MIXED"]);

const nf  = new Intl.NumberFormat("en-US");
const pf  = new Intl.NumberFormat("en-US", { maximumFractionDigits: 2 });
const cf  = new Intl.NumberFormat("en-US", { notation: "compact", maximumFractionDigits: 1 });
const ml  = new Intl.DateTimeFormat("en-US", { month: "short", year: "numeric" });
const mtk = new Intl.DateTimeFormat("en-US", { month: "short" });
const dfmt = d => new Intl.DateTimeFormat("en-US", { year: "numeric", month: "short", day: "numeric" }).format(d);

let cPts = [], cReady = false, rTimer = null, counted = [];
window.addEventListener("resize", () => {
  if (rTimer) clearTimeout(rTimer);
  rTimer = setTimeout(() => { hideTip(); renderChart(counted); }, 150);
});
boot();

async function boot() {
  try {
    const r = await fetch("/api/reports");
    const d = await r.json();
    if (d.ok) render(d.reports); else throw new Error(d.error);
  } catch (e) {
    console.error(e);
    setText("heroHeadline", "Dashboard unavailable");
    document.getElementById("tableBody").innerHTML = '<tr><td colspan="5" class="error-state">Failed to load data.</td></tr>';
    document.getElementById("mobileCards").innerHTML = '<div class="error-state">Failed to load data.</div>';
  }
}

function render(reports) {
  const since = reports.filter(r => parseDate(r.date) >= BASELINE);
  counted = since.filter(r => C_TYPES.has(r.lossType) && C_ATTR.has(r.aiAttribution));
  const total = counted.reduce((s, r) => s + n(r.jobsLost), 0);

  const dates = counted.map(r => parseDate(r.date)).sort((a, b) => a - b);
  const latest = dates[dates.length - 1] || new Date();

  // Pace
  buildPace(counted);

  // Meta
  setText("asOfText", `As of ${dfmt(new Date())} · Latest report: ${counted.length ? dfmt(latest) : "none yet"}`);
  setText("lastUpdated", `Updated ${counted.length ? dfmt(latest) : "—"} · ${counted.length} reports`);
  setText("tableBadge", `${counted.length} reports`);

  // Chart
  renderChart(counted);
  initChartMouse();

  // Animate
  animateCount("counterNumber", total, 2000);

  // Table
  const rows = buildRows(counted);
  buildTable(document.getElementById("tableBody"), rows);
  buildCards(document.getElementById("mobileCards"), rows);
}

function buildPace(reps) {
  const now = new Date();
  const thisM = now.getMonth(), thisY = now.getFullYear();
  const lastM = thisM === 0 ? 11 : thisM - 1;
  const lastY = thisM === 0 ? thisY - 1 : thisY;
  let thisTotal = 0, lastTotal = 0;
  reps.forEach(r => {
    const d = parseDate(r.date);
    if (d.getMonth() === thisM && d.getFullYear() === thisY) thisTotal += n(r.jobsLost);
    if (d.getMonth() === lastM && d.getFullYear() === lastY) lastTotal += n(r.jobsLost);
  });
  const paceEl = document.getElementById("paceNumber");
  const deltaEl = document.getElementById("paceDelta");
  if (lastTotal > 0) {
    const change = ((thisTotal - lastTotal) / lastTotal) * 100;
    const arrow = change > 5 ? "▲" : change < -5 ? "▼" : "—";
    const arrowClass = change > 5 ? "up" : change < -5 ? "down" : "flat";
    paceEl.innerHTML = `<span class="pace-arrow ${arrowClass}">${arrow}</span> ${nf.format(thisTotal)}`;
    deltaEl.textContent = `${change > 0 ? "+" : ""}${Math.round(change)}% vs ${mtk.format(new Date(lastY, lastM))}`;
  } else if (thisTotal > 0) {
    paceEl.textContent = nf.format(thisTotal);
    deltaEl.textContent = `No data for ${mtk.format(new Date(lastY, lastM))}`;
  } else {
    paceEl.textContent = "—";
    deltaEl.textContent = "No reports this month yet";
  }
}

function animateCount(id, target, dur) {
  const el = document.getElementById(id);
  if (!el) return;
  if (target === 0) { el.textContent = "0"; return; }
  el.classList.add("counting");
  const t0 = performance.now();
  const ease = t => t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2, 3) / 2;
  function step(now) {
    const p = Math.min(1, (now - t0) / dur);
    el.textContent = nf.format(Math.floor(target * ease(p)));
    if (p < 1) requestAnimationFrame(step);
    else { el.textContent = nf.format(target); el.classList.remove("counting"); }
  }
  requestAnimationFrame(step);
}

function buildRows(reps) {
  const sorted = [...reps].sort((a, b) => parseDate(a.date) - parseDate(b.date));
  const run = new Map();
  return sorted.map(r => {
    const p = run.get(r.company) || 0;
    const t = p + n(r.jobsLost);
    run.set(r.company, t);
    return { ...r, runningTotal: t };
  }).sort((a, b) => parseDate(b.date) - parseDate(a.date));
}

function isMajor(jobsLost, allRows) {
  if (allRows.length < 4) return n(jobsLost) >= 5000;
  const sorted = allRows.map(r => n(r.jobsLost)).sort((a, b) => b - a);
  return n(jobsLost) >= sorted[Math.max(0, Math.floor(sorted.length * 0.25) - 1)];
}

function attrTag(a) {
  const al = (a || "EXPLICIT").toLowerCase();
  const c = al === "explicit" ? "explicit" : al === "blamed" ? "blamed" : "mixed";
  return `<span class="attr-tag ${c}">${esc(al)}</span>`;
}
function pctPill(r) {
  const wf = n(r.workforce);
  if (wf <= 0) return '<span class="pct-pill">n/a</span>';
  return `<span class="pct-pill">${pf.format((r.runningTotal / wf) * 100)}%</span>`;
}
function srcLink(r) {
  const su = safeUrl(r.sourceUrl);
  const sl = esc(r.sourceLabel || inferSrc(r.sourceUrl));
  return su
    ? `<a class="source-link" href="${su}" target="_blank" rel="noopener">${sl} ↗</a>`
    : `<span style="font-size:0.78rem;color:var(--text-dim)">${sl || "—"}</span>`;
}

function buildTable(body, rows) {
  body.innerHTML = "";
  if (!rows.length) { body.innerHTML = '<tr><td colspan="5" class="loading-state">No reports yet.</td></tr>'; return; }
  rows.forEach(r => {
    const tr = document.createElement("tr");
    if (isMajor(r.jobsLost, rows)) tr.classList.add("major");
    const jobs = `${r.estimate ? "~" : ""}${nf.format(n(r.jobsLost))}`;
    const wf = n(r.workforce);
    const wt = wf > 0 ? `of ${nf.format(wf)}` : "n/a";
    tr.innerHTML = `
      <td><span class="cell-company">${esc(r.company)}</span><span class="cell-meta">${esc(dfmt(parseDate(r.date)))} · ${esc(r.country || "Global")}</span><div style="margin-top:0.2rem">${srcLink(r)}</div></td>
      <td><span class="cell-jobs">${esc(jobs)}</span> ${attrTag(r.aiAttribution)}</td>
      <td>${esc(r.industry || "Unknown")}</td>
      <td>${nf.format(r.runningTotal)}</td>
      <td>${pctPill(r)}<span class="cell-meta">${esc(wt)}</span></td>`;
    body.appendChild(tr);
  });
}

function buildCards(container, rows) {
  container.innerHTML = "";
  if (!rows.length) { container.innerHTML = '<div class="loading-state">No reports yet.</div>'; return; }
  rows.forEach(r => {
    const jobs = `${r.estimate ? "~" : ""}${nf.format(n(r.jobsLost))}`;
    const wf = n(r.workforce);
    const wt = wf > 0 ? `${pf.format((r.runningTotal / wf) * 100)}% of ${nf.format(wf)}` : "n/a";
    const card = document.createElement("div");
    card.className = "report-card" + (isMajor(r.jobsLost, rows) ? " major" : "");
    card.innerHTML = `
      <div class="rc-top">
        <div><div class="rc-company">${esc(r.company)}</div><div class="rc-meta">${esc(dfmt(parseDate(r.date)))} · ${esc(r.country || "Global")}</div></div>
        <div class="rc-jobs">${esc(jobs)}</div>
      </div>
      <div class="rc-grid">
        <div><div class="rc-label">Attribution</div><div class="rc-value">${attrTag(r.aiAttribution)}</div></div>
        <div><div class="rc-label">Industry</div><div class="rc-value">${esc(r.industry || "Unknown")}</div></div>
        <div><div class="rc-label">Running total</div><div class="rc-value">${nf.format(r.runningTotal)}</div></div>
        <div><div class="rc-label">Workforce</div><div class="rc-value">${esc(wt)}</div></div>
        <div><div class="rc-label">Source</div><div class="rc-value">${srcLink(r)}</div></div>
      </div>`;
    container.appendChild(card);
  });
}

/* ═══ Chart — dark-on-light colors ═══ */
function renderChart(reps) {
  const canvas = document.getElementById("monthlyLossChart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const dpr = devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, rect.width, rect.height);
  const sum = document.getElementById("monthlyLossSummary");
  if (!reps || !reps.length) { if (sum) sum.textContent = "No data yet."; cPts = []; return; }

  const bm = new Map();
  reps.forEach(r => {
    const d = parseDate(r.date);
    const k = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    bm.set(k, (bm.get(k) || 0) + n(r.jobsLost));
  });
  const keys = [...bm.keys()].sort();
  let cum = 0;
  const pts = keys.map(k => { cum += bm.get(k); const [y, m] = k.split("-").map(Number); return { date: new Date(y, m - 1, 1), total: cum }; });
  if (!pts.length) { if (sum) sum.textContent = "No data yet."; cPts = []; return; }

  const pad = { top: 14, right: 12, bottom: 22, left: 44 };
  const w = rect.width - pad.left - pad.right, h = rect.height - pad.top - pad.bottom;
  const mx = Math.max(...pts.map(p => p.total)) * 1.08;
  const xS = i => pad.left + (pts.length === 1 ? w / 2 : (i / (pts.length - 1)) * w);
  const yS = v => pad.top + h - (v / mx) * h;

  // Grid lines
  ctx.strokeStyle = "rgba(25,45,23,0.08)"; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + (i / 4) * h;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + w, y); ctx.stroke();
    ctx.fillStyle = "rgba(25,45,23,0.4)";
    ctx.font = "600 10px 'Libre Franklin',sans-serif"; ctx.textAlign = "right";
    ctx.fillText(cf.format(mx - (i / 4) * mx), pad.left - 6, y + 4);
  }
  ctx.textAlign = "center"; ctx.fillStyle = "rgba(25,45,23,0.35)";
  pts.forEach((p, i) => ctx.fillText(mtk.format(p.date), xS(i), rect.height - 4));

  // Area fill
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + h);
  grad.addColorStop(0, "rgba(61,107,53,0.18)"); grad.addColorStop(1, "rgba(61,107,53,0.02)");
  ctx.beginPath(); ctx.moveTo(xS(0), yS(0));
  pts.forEach((p, i) => ctx.lineTo(xS(i), yS(p.total)));
  ctx.lineTo(xS(pts.length - 1), yS(0)); ctx.closePath();
  ctx.fillStyle = grad; ctx.fill();

  // Line
  ctx.beginPath();
  pts.forEach((p, i) => { const x = xS(i), y = yS(p.total); i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y); });
  ctx.strokeStyle = "#3d6b35"; ctx.lineWidth = 2.4; ctx.lineJoin = "round"; ctx.stroke();

  // Dots
  pts.forEach((p, i) => {
    ctx.beginPath(); ctx.arc(xS(i), yS(p.total), 3.5, 0, Math.PI * 2);
    ctx.fillStyle = "#3d6b35"; ctx.fill();
    ctx.strokeStyle = "#fff"; ctx.lineWidth = 1.6; ctx.stroke();
  });

  cPts = pts.map((p, i) => ({ x: xS(i), y: yS(p.total), date: p.date, total: p.total }));
  if (sum) { const last = pts[pts.length - 1]; sum.textContent = `${nf.format(last.total)} cumulative through ${ml.format(last.date)}.`; }
}

function getEl(c) {
  let e = document.querySelector("." + c);
  if (!e) { e = document.createElement("div"); e.className = c; e.hidden = true; document.querySelector(".trend-panel")?.appendChild(e); }
  return e;
}
function hideTip() {
  const t = document.querySelector(".chart-tooltip"), m = document.querySelector(".chart-point-highlight");
  if (t) t.hidden = true; if (m) m.hidden = true;
}
function initChartMouse() {
  if (cReady) return;
  const c = document.getElementById("monthlyLossChart"); if (!c) return;
  c.addEventListener("pointermove", onChart);
  c.addEventListener("pointerdown", onChart);
  c.addEventListener("pointerleave", hideTip);
  cReady = true;
}
function onChart(e) {
  const c = e.currentTarget;
  if (!c || !cPts.length) { hideTip(); return; }
  const rect = c.getBoundingClientRect(), x = e.clientX - rect.left;
  if (x < 0 || x > rect.width) { hideTip(); return; }
  const near = cPts.reduce((b, p) => Math.abs(p.x - x) < Math.abs(b.x - x) ? p : b, cPts[0]);
  const panel = c.closest(".trend-panel"), tip = getEl("chart-tooltip"), dot = getEl("chart-point-highlight");
  if (!panel) return;
  tip.textContent = `${ml.format(near.date)}: ${nf.format(near.total)}`;
  tip.hidden = false;
  const pr = panel.getBoundingClientRect(), hw = tip.offsetWidth / 2;
  tip.style.left = `${Math.min(pr.width - 8 - hw, Math.max(8 + hw, rect.left - pr.left + x))}px`;
  tip.style.top = `${rect.top - pr.top + near.y}px`;
  dot.hidden = false;
  dot.style.left = `${rect.left - pr.left + near.x}px`;
  dot.style.top = `${rect.top - pr.top + near.y}px`;
}

/* Utils */
function parseDate(v) {
  if (typeof v === "string") {
    let m = v.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m) return new Date(+m[1], +m[2] - 1, +m[3]);
    m = v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (m) return new Date(+m[3], +m[1] - 1, +m[2]);
  }
  const d = new Date(v); return isNaN(d.getTime()) ? BASELINE : d;
}
function n(v) { const x = Number(v); return isFinite(x) ? x : 0; }
function esc(s) { return String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;"); }
function safeUrl(u) { if (!u) return ""; try { const p = new URL(u, location.href); return /^https?:$/.test(p.protocol) ? p.toString() : ""; } catch { return ""; } }
function inferSrc(u) { if (!u) return "Source"; try { const h = new URL(u).hostname; if (h.includes("apnews")) return "AP"; if (h.includes("cnbc")) return "CNBC"; if (h.includes("reuters")) return "Reuters"; return h.replace("www.", ""); } catch { return "Source"; } }
function setText(id, t) { const el = document.getElementById(id); if (el) el.textContent = t; }
</script>
</body>
</html>
