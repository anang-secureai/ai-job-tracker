<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Job Loss Tracker — The Alliance for Secure AI</title>
  <meta name="description" content="Tracking AI-linked job losses since January 2025. A public-interest dashboard by The Alliance for Secure AI." />
  <meta property="og:title" content="AI Job Loss Tracker" />
  <meta property="og:description" content="Tracking AI-linked job losses since January 2025." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
<style>
:root {
  --seaweed: #192d17; --gamboge: #e4991b; --rangoon: #181c14;
  --green: #709663; --ink: #f3f7f1; --ink-mid: #b8c8b1;
  --line: rgba(255,255,255,0.16); --card: rgba(24,28,20,0.72); --card-strong: rgba(24,28,20,0.94);
}
*{box-sizing:border-box}html,body{margin:0;min-height:100%}
body{font-family:"Libre Franklin","Franklin Gothic Medium","Arial Narrow",Arial,sans-serif;color:var(--ink);background:radial-gradient(circle at 9% -8%,rgba(112,150,99,0.28),transparent 33%),radial-gradient(circle at 88% 4%,rgba(228,153,27,0.22),transparent 31%),linear-gradient(160deg,var(--seaweed),var(--rangoon))}

/* CRT */
.crt-overlay{position:fixed;inset:0;pointer-events:none;z-index:999;mix-blend-mode:soft-light;opacity:0.35;background:repeating-linear-gradient(0deg,rgba(243,247,241,0.08) 0 1px,rgba(24,28,20,0) 1px 3px);animation:crtFlicker 5.4s steps(1,end) infinite}
.crt-overlay::before{content:"";position:absolute;inset:-140% 0;background:linear-gradient(180deg,rgba(243,247,241,0) 0%,rgba(243,247,241,0.06) 48%,rgba(243,247,241,0) 52%);animation:scanSweep 9s linear infinite}

/* Layout */
.page{width:min(1120px,94vw);margin:0 auto;padding:2rem 0 1rem}

/* Brand */
.brand-header{display:flex;align-items:flex-start;gap:1rem;padding-bottom:1.5rem;border-bottom:1px solid var(--line)}
.brand-lockup{display:flex;flex-direction:column;gap:0.35rem}
.brand-logo-full{display:block;width:min(259px,50vw);height:auto}
.brand-subline{margin:0;color:var(--ink-mid);font-size:0.82rem;letter-spacing:0.09em;text-transform:uppercase}
.shield-logo{display:block;flex:0 0 auto}.logo-sm{height:2rem;width:auto}.logo-xs{height:1.2rem;width:auto}

/* Hero */
.hero{margin-top:1.5rem}
.hero-grid{display:grid;grid-template-columns:minmax(0,1.15fr) minmax(260px,0.85fr);gap:1.1rem;align-items:start}
.hero-copy{min-width:0}
.eyebrow{margin:0;color:var(--green);letter-spacing:0.12em;text-transform:uppercase;font-size:0.75rem;font-weight:700}
.hero h1{margin:0.4rem 0 0;max-width:17ch;font-size:clamp(1.7rem,5vw,4.1rem);line-height:1.04;font-weight:900}
.subtitle{margin:0.85rem 0 0;max-width:66ch;line-height:1.5;color:var(--ink-mid);font-size:0.92rem}
.last-updated{margin:0.55rem 0 0;font-size:0.75rem;font-weight:700;color:var(--gamboge)}

/* Trend chart */
.trend-panel{position:relative;border-radius:0.86rem;border:1px solid rgba(112,150,99,0.35);background:linear-gradient(180deg,rgba(112,150,99,0.16),rgba(24,28,20,0.5));padding:0.75rem 0.85rem 0.65rem}
.trend-kicker{margin:0;font-size:0.64rem;text-transform:uppercase;letter-spacing:0.12em;color:var(--green);font-weight:700}
.trend-panel h2{margin:0.3rem 0 0.5rem;font-size:0.9rem}
#monthlyLossChart{display:block;width:100%;height:180px}
.trend-summary{margin:0.4rem 0 0;color:#d7e2d3;font-size:0.74rem;line-height:1.38}
.chart-tooltip{position:absolute;left:0;top:0;transform:translate(-50%,calc(-100% - 10px));z-index:6;pointer-events:none;white-space:nowrap;padding:0.32rem 0.48rem;border-radius:0.5rem;border:1px solid rgba(228,153,27,0.68);background:rgba(16,21,14,0.95);color:#f2f6f0;font-size:0.7rem;font-weight:700;box-shadow:0 0.5rem 1rem rgba(0,0,0,0.28)}
.chart-point-highlight{position:absolute;left:0;top:0;width:0.65rem;height:0.65rem;border-radius:50%;transform:translate(-50%,-50%);z-index:5;pointer-events:none;border:2px solid var(--ink);background:var(--gamboge);box-shadow:0 0 0 0.2rem rgba(228,153,27,0.28)}

/* Counter */
.counter-panel{margin-top:1.4rem;padding:1rem;border:1px solid rgba(228,153,27,0.34);border-radius:1rem;background:linear-gradient(180deg,rgba(27,38,25,0.85),rgba(24,28,20,0.85))}
.counter-head{display:flex;align-items:flex-start;gap:0.85rem}
.counter-title{display:flex;align-items:center;gap:0.6rem}
.counter-title h2{margin:0;font-size:1.05rem}
.counter-title p{margin:0.15rem 0 0;color:var(--ink-mid);font-size:0.82rem}
.flip-counter{display:flex;flex-wrap:nowrap;gap:clamp(0.2rem,1vw,0.44rem);align-items:center;margin-top:0.85rem}
.digit{--dh:clamp(2.4rem,8vw,4.2rem);--df:clamp(1.15rem,4.2vw,2.25rem);position:relative;width:clamp(1.75rem,5.8vw,3.2rem);height:var(--dh);font-family:"Libre Franklin","Arial Narrow",sans-serif;perspective:300px;transform-style:preserve-3d}
.digit .half{position:absolute;left:0;width:100%;height:50%;overflow:hidden;background:linear-gradient(180deg,#121711,#0f130e);color:#f6f9f4;font-weight:800;font-size:var(--df);font-variant-numeric:tabular-nums}
.digit .top{top:0;border-radius:0.4rem 0.4rem 0.1rem 0.1rem;border-bottom:1px solid rgba(228,153,27,0.36);transform-origin:bottom}
.digit .bottom{bottom:0;border-radius:0.1rem 0.1rem 0.4rem 0.4rem;transform-origin:top}
.digit .flap{position:absolute;left:0;width:100%;height:50%;overflow:hidden;font-weight:800;font-size:var(--df);color:#fff;backface-visibility:hidden;pointer-events:none;visibility:hidden;font-variant-numeric:tabular-nums}
.digit .flap-top{top:0;background:linear-gradient(180deg,#293827,#161f14);border-radius:0.4rem 0.4rem 0.1rem 0.1rem;transform-origin:bottom;transform:rotateX(0deg);z-index:3}
.digit .flap-bottom{bottom:0;background:linear-gradient(180deg,#161f14,#10150f);border-radius:0.1rem 0.1rem 0.4rem 0.4rem;transform-origin:top;transform:rotateX(90deg);z-index:2}
.digit .digit-value{position:absolute;top:0;left:0;width:100%;height:var(--dh);display:flex;align-items:center;justify-content:center;line-height:1;transform:translateY(-0.02em);text-shadow:0 0 0.38rem rgba(243,247,241,0.34),0 0 1rem rgba(112,150,99,0.35)}
.digit .bottom .digit-value,.digit .flap-bottom .digit-value{transform:translateY(calc(-50% - 0.02em))}
.digit.flip .flap-top{visibility:visible;animation:flapTop 0.34s ease-in forwards}
.digit.flip .flap-bottom{visibility:visible;animation:flapBottom 0.34s ease-out 0.34s forwards}

/* Stats */
.stats{margin-top:0.85rem;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:0.65rem}
.stat-card{border-radius:0.75rem;padding:0.7rem 0.85rem;border:1px solid var(--line);background:var(--card)}
.stat-card h3{margin:0.3rem 0 0;font-size:0.8rem;color:var(--ink-mid)}
.stat-card p{margin:0.3rem 0 0;font-size:clamp(1.2rem,3vw,2rem);font-family:"Libre Franklin","Arial Narrow",sans-serif;font-weight:800}

/* Method */
.method{margin-top:0.85rem;border-radius:0.75rem;padding:0.85rem;background:rgba(112,150,99,0.16);border-left:4px solid var(--gamboge)}
.method h2{margin:0;font-size:0.95rem}
.method p{margin:0.45rem 0 0;color:#d7e2d3;line-height:1.45;font-size:0.88rem}
.method p+p{margin-top:0.3rem}

/* ── Desktop table ─── */
.company-grid-section{margin-top:1rem;border:1px solid var(--line);border-radius:1rem;background:var(--card-strong);padding:0.85rem}
.table-disclaimer{margin:0.5rem 0 0;font-size:0.7rem;color:var(--ink-mid);line-height:1.4;font-style:italic}
.table-wrap{overflow-x:auto;border:1px solid rgba(255,255,255,0.18);border-radius:0.7rem}
table{width:100%;table-layout:fixed;border-collapse:collapse}
thead th{text-align:left;font-size:0.72rem;letter-spacing:0.05em;text-transform:uppercase;color:#d0ddcb;background:rgba(112,150,99,0.2);padding:0.6rem;white-space:normal;overflow-wrap:anywhere}
tbody td{padding:0.6rem;border-top:1px solid rgba(255,255,255,0.09);font-size:0.88rem;color:#edf3eb;vertical-align:top;overflow-wrap:anywhere}
thead th:nth-child(1),tbody td:nth-child(1){width:28%}
thead th:nth-child(2),tbody td:nth-child(2){width:14%}
thead th:nth-child(3),tbody td:nth-child(3){width:16%}
thead th:nth-child(4),tbody td:nth-child(4){width:14%}
thead th:nth-child(5),tbody td:nth-child(5){width:14%}
thead th:nth-child(6),tbody td:nth-child(6){width:14%}
tbody tr:nth-child(even){background:rgba(255,255,255,0.03)}

/* ── Mobile cards ─── */
.mobile-cards{display:none}
.report-card{border:1px solid var(--line);border-radius:0.75rem;padding:0.85rem;background:rgba(255,255,255,0.03);margin-bottom:0.6rem}
.report-card:last-child{margin-bottom:0}
.rc-top{display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem}
.rc-company{font-weight:800;font-size:1rem}
.rc-jobs{font-weight:800;font-size:1.05rem;white-space:nowrap;color:var(--gamboge)}
.rc-meta{color:var(--ink-mid);font-size:0.76rem;margin-top:0.15rem}
.rc-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.4rem 0.85rem;margin-top:0.6rem;padding-top:0.6rem;border-top:1px solid rgba(255,255,255,0.08)}
.rc-label{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--ink-mid);font-weight:600}
.rc-value{font-size:0.84rem;font-weight:600;margin-top:0.05rem}

/* Shared pills */
.cell-company{font-weight:700}
.cell-meta{color:var(--ink-mid);font-size:0.78rem;display:block;margin-top:0.15rem}
.source-link{color:#ffe2b1;font-size:0.78rem;text-decoration:underline}.source-link:hover{color:#fff}
.pct-pill{display:inline-flex;align-items:center;border-radius:999px;padding:0.14rem 0.48rem;background:rgba(228,153,27,0.2);border:1px solid rgba(228,153,27,0.5);font-weight:700;font-size:0.85rem}
.stock-pill{display:inline-flex;align-items:center;border-radius:999px;padding:0.14rem 0.48rem;font-weight:700;white-space:nowrap;font-size:0.85rem}
.stock-pill.pos{color:#d1f5d1;background:rgba(112,150,99,0.22);border:1px solid rgba(112,150,99,0.58)}
.stock-pill.neg{color:#ffd0c8;background:rgba(188,62,41,0.22);border:1px solid rgba(188,62,41,0.58)}
.stock-pill.na{color:#e8ece6;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.22)}
.attr-tag{display:inline-block;font-size:0.64rem;font-weight:700;letter-spacing:0.04em;text-transform:uppercase;padding:0.1rem 0.35rem;border-radius:999px}
.attr-tag.explicit{background:rgba(112,150,99,0.24);color:#d4edc9;border:1px solid rgba(112,150,99,0.5)}
.attr-tag.blamed{background:rgba(228,153,27,0.2);color:#f9ddb2;border:1px solid rgba(228,153,27,0.5)}
.attr-tag.mixed{background:rgba(255,255,255,0.08);color:#ccc;border:1px solid rgba(255,255,255,0.2)}

/* Loading / error */
.loading-state{text-align:center;padding:2.5rem 1rem;color:var(--ink-mid)}
.loading-state .spinner{display:inline-block;width:1.4rem;height:1.4rem;border:2px solid var(--line);border-top-color:var(--gamboge);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:0.5rem}
.error-state{text-align:center;padding:2rem 1rem;color:#e88}

/* Footer */
.site-footer{margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--line)}
.footer-inner{display:flex;align-items:center;gap:1rem}
.footer-logo{width:130px;height:auto;opacity:0.6}
.site-footer p{margin:0;color:var(--ink-mid);font-size:0.75rem;line-height:1.45}
.site-footer a{color:var(--gamboge);text-decoration:underline}.site-footer a:hover{color:#fff}

/* ── Responsive ─── */
@media(max-width:768px){
  .page{padding:1.2rem 0 0.8rem}
  .hero-grid{grid-template-columns:1fr;gap:1rem}
  .hero h1{font-size:clamp(1.5rem,7vw,2.4rem)}
  .subtitle{font-size:0.85rem}
  .stats{gap:0.45rem}
  .stat-card{padding:0.55rem 0.6rem}
  .stat-card h3{font-size:0.7rem}
  .stat-card p{font-size:1.15rem}
  .stat-card .shield-logo{display:none}
  .counter-head{flex-direction:column;gap:0.5rem}
  .counter-title h2{font-size:0.95rem}
  .counter-title p{font-size:0.75rem}
  .method{padding:0.7rem}
  .method p{font-size:0.82rem}
  .company-grid-section{padding:0.65rem}
  .table-wrap{display:none}
  .mobile-cards{display:block}
  .footer-inner{flex-direction:column;align-items:flex-start;gap:0.6rem}
  .footer-logo{width:110px}
}
@media(max-width:420px){
  .page{width:96vw}
  .stats{grid-template-columns:1fr 1fr 1fr;gap:0.3rem}
  .stat-card{padding:0.4rem 0.45rem}
  .counter-panel{padding:0.75rem}
  .flip-counter{gap:0.12rem}
  .brand-logo-full{width:min(200px,55vw)}
}
@keyframes flapTop{from{transform:rotateX(0deg)}to{transform:rotateX(-90deg)}}
@keyframes flapBottom{from{transform:rotateX(90deg)}to{transform:rotateX(0deg)}}
@keyframes crtFlicker{0%,7%,38%,66%,100%{opacity:.35}8%,37%{opacity:.31}67%{opacity:.4}}
@keyframes scanSweep{from{transform:translateY(-55%)}to{transform:translateY(55%)}}
@keyframes spin{to{transform:rotate(360deg)}}
@media(prefers-reduced-motion:reduce){.crt-overlay,.crt-overlay::before{animation:none!important}}
</style>
</head>
<body>
<main class="page">
  <header class="brand-header">
    <div class="brand-lockup">
      <img class="brand-logo-full" src="/assets/the-alliance-logo-white-1600.png" alt="The Alliance for Secure AI" width="1600" height="583" decoding="async" />
      <p class="brand-subline">AI Job Loss Tracker</p>
    </div>
  </header>
  <section class="hero">
    <div class="hero-grid">
      <div class="hero-copy">
        <p class="eyebrow">U.S. + Global Monitor</p>
        <h1>AI-linked job losses since early 2025</h1>
        <p class="subtitle">This dashboard counts newly reported layoffs where AI is either explicitly cited or credibly blamed as a material factor. Reporting window starts January&nbsp;1,&nbsp;2025.</p>
        <p class="last-updated" id="lastUpdated"></p>
      </div>
      <aside class="trend-panel" aria-labelledby="trendHeading">
        <p class="trend-kicker">Trendline</p>
        <h2 id="trendHeading">Cumulative AI job losses</h2>
        <canvas id="monthlyLossChart" role="img" aria-label="Cumulative AI job losses chart"></canvas>
        <p id="monthlyLossSummary" class="trend-summary">Loading...</p>
      </aside>
    </div>
  </section>
  <section class="counter-panel" aria-labelledby="counter-heading">
    <div class="counter-head">
      <div class="counter-title">
        <img class="shield-logo logo-sm" src="/assets/the-alliance-shield-white-256.png" alt="" aria-hidden="true" width="219" height="256" decoding="async" />
        <div><h2 id="counter-heading">Total AI-linked job losses</h2><p id="asOfText">Loading...</p></div>
      </div>
    </div>
    <div id="flipCounter" class="flip-counter" aria-live="polite"><div class="loading-state"><div class="spinner"></div></div></div>
  </section>
  <section class="stats" aria-label="Regional breakdown">
    <article class="stat-card"><img class="shield-logo logo-xs" src="/assets/the-alliance-shield-white-256.png" alt="" aria-hidden="true" /><h3>United States</h3><p id="usTotal">—</p></article>
    <article class="stat-card"><img class="shield-logo logo-xs" src="/assets/the-alliance-shield-white-256.png" alt="" aria-hidden="true" /><h3>Outside U.S.</h3><p id="intlTotal">—</p></article>
    <article class="stat-card"><img class="shield-logo logo-xs" src="/assets/the-alliance-shield-white-256.png" alt="" aria-hidden="true" /><h3>Reports</h3><p id="countedReports">—</p></article>
  </section>
  <section class="method">
    <h2>Counting method</h2>
    <p><strong>Included:</strong> First-time layoffs where AI was a material factor — either explicitly cited by the company, or identified by credible reporting as a primary driver. <strong>Excluded:</strong> Restated totals, duplicate announcements, and layoffs attributed solely to non-AI factors.</p>
    <p>Stock figures show change from announcement-day close to most recent close and <strong>do not imply the layoffs caused the stock movement</strong>.</p>
  </section>
  <section class="company-grid-section">
    <div class="table-wrap">
      <table><thead><tr><th>Company</th><th>Jobs lost</th><th>Industry</th><th>Running total</th><th>Workforce %</th><th>Stock Δ</th></tr></thead>
      <tbody id="tableBody"><tr><td colspan="6" class="loading-state"><div class="spinner"></div><br/>Loading...</td></tr></tbody></table>
    </div>
    <div class="mobile-cards" id="mobileCards"><div class="loading-state"><div class="spinner"></div><br/>Loading...</div></div>
    <p class="table-disclaimer">Stock data via Stooq daily close history. Figures are directional only.</p>
  </section>
  <footer class="site-footer">
    <div class="footer-inner">
      <img class="footer-logo" src="/assets/the-alliance-logo-white-1600.png" alt="The Alliance for Secure AI" width="1600" height="583" decoding="async" loading="lazy" />
      <p>A public-interest project by <a href="https://theallianceforai.org" target="_blank" rel="noopener">The Alliance for Secure AI</a>. Data sourced from AP, Reuters, CNBC, and other major outlets.</p>
    </div>
  </footer>
</main>
<div class="crt-overlay" aria-hidden="true"></div>
<script>
const BASELINE=new Date(2025,0,1),C_TYPES=new Set(["NEW"]),C_ATTR=new Set(["EXPLICIT","BLAMED","MIXED"]);
const nf=new Intl.NumberFormat("en-US"),pf=new Intl.NumberFormat("en-US",{maximumFractionDigits:2}),cf=new Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:1}),ml=new Intl.DateTimeFormat("en-US",{month:"short",year:"numeric"}),mtk=new Intl.DateTimeFormat("en-US",{month:"short"}),dfmt=d=>new Intl.DateTimeFormat("en-US",{year:"numeric",month:"short",day:"numeric"}).format(d);
let cDigits=[],dVal=0,cAnim=null,cPts=[],cReady=false,rTimer=null,counted=[];
window.addEventListener("resize",()=>{if(rTimer)clearTimeout(rTimer);rTimer=setTimeout(()=>{hideTip();renderChart(counted)},150)});
boot();

async function boot(){try{const r=await fetch("/api/reports");const d=await r.json();if(d.ok)render(d.reports);else throw new Error(d.error)}catch(e){console.error(e);document.getElementById("tableBody").innerHTML='<tr><td colspan="6" class="error-state">Failed to load.</td></tr>';document.getElementById("mobileCards").innerHTML='<div class="error-state">Failed to load data.</div>'}}

function render(reports){
  const since=reports.filter(r=>parseDate(r.date)>=BASELINE);
  counted=since.filter(r=>C_TYPES.has(r.lossType)&&C_ATTR.has(r.aiAttribution));
  const total=counted.reduce((s,r)=>s+n(r.jobsLost),0);
  const us=counted.filter(r=>r.region==="US").reduce((s,r)=>s+n(r.jobsLost),0);
  const intl=counted.filter(r=>r.region!=="US").reduce((s,r)=>s+n(r.jobsLost),0);
  const latest=counted.reduce((mx,r)=>{const d=parseDate(r.date);return d>mx?d:mx},BASELINE);
  setText("asOfText",`As of ${dfmt(new Date())} · Latest: ${counted.length?dfmt(latest):"none yet"}`);
  setText("lastUpdated",`Last updated: ${counted.length?dfmt(latest):"—"} · ${counted.length} reports`);
  setText("usTotal","0");setText("intlTotal","0");setText("countedReports","0");
  renderChart(counted);initChartMouse();
  cDigits=createCounter(total);dVal=0;updateDigits(0,cDigits);
  animateCounter(total,2200);animateText("usTotal",us,2200);animateText("intlTotal",intl,2200);animateText("countedReports",counted.length,1800);
  const rows=buildRows(counted);
  buildTable(document.getElementById("tableBody"),rows);
  buildCards(document.getElementById("mobileCards"),rows);
}

function buildRows(reps){
  const sorted=[...reps].sort((a,b)=>parseDate(a.date)-parseDate(b.date));
  const run=new Map();
  return sorted.map(r=>{const p=run.get(r.company)||0;const t=p+n(r.jobsLost);run.set(r.company,t);return{...r,runningTotal:t}}).sort((a,b)=>parseDate(b.date)-parseDate(a.date));
}

function stockPill(sd){const cls=sd==null?"na":sd>=0?"pos":"neg";const txt=sd==null?"n/a":`${sd>0?"+":""}${pf.format(sd)}%`;return `<span class="stock-pill ${cls}">${esc(txt)}</span>`}
function attrTag(a){const al=(a||"EXPLICIT").toLowerCase();const c=al==="explicit"?"explicit":al==="blamed"?"blamed":"mixed";return `<span class="attr-tag ${c}">${esc(al)}</span>`}
function pctPill(r){const wf=n(r.workforce);if(wf<=0)return'<span class="pct-pill">n/a</span>';return `<span class="pct-pill">${pf.format((r.runningTotal/wf)*100)}%</span>`}
function srcLink(r){const su=safeUrl(r.sourceUrl);const sl=esc(r.sourceLabel||inferSrc(r.sourceUrl));return su?`<a class="source-link" href="${su}" target="_blank" rel="noopener">${sl}</a>`:`<span style="font-size:0.78rem;color:var(--ink-mid)">${sl||"—"}</span>`}

function buildTable(body,rows){
  body.innerHTML="";
  if(!rows.length){body.innerHTML='<tr><td colspan="6" class="loading-state">No reports yet.</td></tr>';return}
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    const jobs=`${r.estimate?"~":""}${nf.format(n(r.jobsLost))}`;
    const wf=n(r.workforce);const wt=wf>0?`of ${nf.format(wf)}`:"n/a";
    tr.innerHTML=`<td><span class="cell-company">${esc(r.company)}</span><span class="cell-meta">${esc(dfmt(parseDate(r.date)))} · ${esc(r.country||"Global")}</span><div style="margin-top:0.2rem">${srcLink(r)}</div></td><td>${esc(jobs)} ${attrTag(r.aiAttribution)}</td><td>${esc(r.industry||"Unknown")}</td><td>${nf.format(r.runningTotal)}</td><td>${pctPill(r)}<span class="cell-meta">${esc(wt)}</span></td><td>${stockPill(r.stockDeltaPct)}</td>`;
    body.appendChild(tr);
  });
}

function buildCards(container,rows){
  container.innerHTML="";
  if(!rows.length){container.innerHTML='<div class="loading-state">No reports yet.</div>';return}
  rows.forEach(r=>{
    const jobs=`${r.estimate?"~":""}${nf.format(n(r.jobsLost))}`;
    const wf=n(r.workforce);const wt=wf>0?`${pf.format((r.runningTotal/wf)*100)}% of ${nf.format(wf)}`:"n/a";
    const card=document.createElement("div");card.className="report-card";
    card.innerHTML=`
      <div class="rc-top">
        <div><div class="rc-company">${esc(r.company)}</div><div class="rc-meta">${esc(dfmt(parseDate(r.date)))} · ${esc(r.country||"Global")}</div></div>
        <div class="rc-jobs">${esc(jobs)}</div>
      </div>
      <div class="rc-grid">
        <div><div class="rc-label">Attribution</div><div class="rc-value">${attrTag(r.aiAttribution)}</div></div>
        <div><div class="rc-label">Industry</div><div class="rc-value">${esc(r.industry||"Unknown")}</div></div>
        <div><div class="rc-label">Running total</div><div class="rc-value">${nf.format(r.runningTotal)}</div></div>
        <div><div class="rc-label">Workforce</div><div class="rc-value">${esc(wt)}</div></div>
        <div><div class="rc-label">Stock Δ</div><div class="rc-value">${stockPill(r.stockDeltaPct)}</div></div>
        <div><div class="rc-label">Source</div><div class="rc-value">${srcLink(r)}</div></div>
      </div>`;
    container.appendChild(card);
  });
}

/* ── Flip Counter ─── */
function createCounter(t){const el=document.getElementById("flipCounter");const len=Math.max(1,String(t).length);const d=[];el.innerHTML="";for(let i=0;i<len;i++){const e=document.createElement("div");e.className="digit";e.dataset.value="0";e.innerHTML='<div class="half top"><span class="digit-value">0</span></div><div class="half bottom"><span class="digit-value">0</span></div><div class="flap flap-top"><span class="digit-value">0</span></div><div class="flap flap-bottom"><span class="digit-value">0</span></div>';el.appendChild(e);d.push(e)}return d}
function updateDigits(v,d){String(v).padStart(d.length,"0").split("").forEach((c,i)=>flip(d[i],c))}
function flip(d,nx){if(!d)return;const cur=d.dataset.value;if(cur===nx)return;const t=d.querySelector(".top .digit-value"),b=d.querySelector(".bottom .digit-value"),ft=d.querySelector(".flap-top .digit-value"),fb=d.querySelector(".flap-bottom .digit-value"),fbf=d.querySelector(".flap-bottom");if(!t)return;if(d.classList.contains("flip")){d.dataset.pending=nx;return}clr(d);t.textContent=cur;b.textContent=nx;ft.textContent=cur;fb.textContent=nx;d.classList.add("flip");let done=false;const fin=()=>{if(done)return;done=true;clr(d);[t,b,ft,fb].forEach(f=>{if(f)f.textContent=nx});d.dataset.value=nx;d.classList.remove("flip");const p=d.dataset.pending;if(p&&p!==nx){delete d.dataset.pending;flip(d,p)}else delete d.dataset.pending};d._fh=fin;d._ft=setTimeout(fin,760);fbf.addEventListener("animationend",fin,{once:true})}
function clr(d){if(!d)return;const fb=d.querySelector(".flap-bottom");if(fb&&d._fh)fb.removeEventListener("animationend",d._fh);if(d._ft)clearTimeout(d._ft);d._fh=null;d._ft=null}
function animateCounter(target,dur){const start=dVal,t0=performance.now();if(cAnim)cancelAnimationFrame(cAnim);const step=now=>{const p=Math.min(1,(now-t0)/dur);const v=Math.floor(start+(target-start)*(1-Math.pow(1-p,3)));if(v>dVal){dVal=v;updateDigits(v,cDigits)}if(p<1)cAnim=requestAnimationFrame(step);else{dVal=target;updateDigits(target,cDigits);setTimeout(()=>{String(target).padStart(cDigits.length,"0").split("").forEach((c,i)=>{const d=cDigits[i];if(!d)return;clr(d);d.classList.remove("flip");delete d.dataset.pending;d.dataset.value=c;d.querySelectorAll(".digit-value").forEach(f=>f.textContent=c)})},800)}};cAnim=requestAnimationFrame(step)}
function animateText(id,target,dur){const el=document.getElementById(id);if(!el)return;const t0=performance.now();const step=now=>{const p=Math.min(1,(now-t0)/dur);el.textContent=nf.format(Math.floor(target*(1-Math.pow(1-p,3))));if(p<1)requestAnimationFrame(step);else el.textContent=nf.format(target)};requestAnimationFrame(step)}

/* ── Chart ─── */
function renderChart(reps){const canvas=document.getElementById("monthlyLossChart");if(!canvas)return;const ctx=canvas.getContext("2d");const dpr=devicePixelRatio||1;const rect=canvas.getBoundingClientRect();canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;ctx.setTransform(dpr,0,0,dpr,0,0);ctx.clearRect(0,0,rect.width,rect.height);const sum=document.getElementById("monthlyLossSummary");if(!reps||!reps.length){if(sum)sum.textContent="No data yet.";cPts=[];return}const bm=new Map();reps.forEach(r=>{const d=parseDate(r.date);const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;bm.set(k,(bm.get(k)||0)+n(r.jobsLost))});const keys=[...bm.keys()].sort();let cum=0;const pts=keys.map(k=>{cum+=bm.get(k);const[y,m]=k.split("-").map(Number);return{date:new Date(y,m-1,1),total:cum}});if(!pts.length){if(sum)sum.textContent="No data yet.";cPts=[];return}const pad={top:14,right:12,bottom:22,left:44};const w=rect.width-pad.left-pad.right,h=rect.height-pad.top-pad.bottom;const mx=Math.max(...pts.map(p=>p.total))*1.08;const xS=i=>pad.left+(pts.length===1?w/2:(i/(pts.length-1))*w);const yS=v=>pad.top+h-(v/mx)*h;ctx.strokeStyle="rgba(255,255,255,0.07)";ctx.lineWidth=1;for(let i=0;i<=4;i++){const y=pad.top+(i/4)*h;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+w,y);ctx.stroke();ctx.fillStyle="rgba(255,255,255,0.35)";ctx.font="600 10px 'Libre Franklin',sans-serif";ctx.textAlign="right";ctx.fillText(cf.format(mx-(i/4)*mx),pad.left-6,y+4)}ctx.textAlign="center";ctx.fillStyle="rgba(255,255,255,0.4)";pts.forEach((p,i)=>ctx.fillText(mtk.format(p.date),xS(i),rect.height-4));const grad=ctx.createLinearGradient(0,pad.top,0,pad.top+h);grad.addColorStop(0,"rgba(228,153,27,0.28)");grad.addColorStop(1,"rgba(228,153,27,0.02)");ctx.beginPath();ctx.moveTo(xS(0),yS(0));pts.forEach((p,i)=>ctx.lineTo(xS(i),yS(p.total)));ctx.lineTo(xS(pts.length-1),yS(0));ctx.closePath();ctx.fillStyle=grad;ctx.fill();ctx.beginPath();pts.forEach((p,i)=>{const x=xS(i),y=yS(p.total);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});ctx.strokeStyle="#e4991b";ctx.lineWidth=2.4;ctx.lineJoin="round";ctx.stroke();pts.forEach((p,i)=>{ctx.beginPath();ctx.arc(xS(i),yS(p.total),3.5,0,Math.PI*2);ctx.fillStyle="#e4991b";ctx.fill();ctx.strokeStyle="#f3f7f1";ctx.lineWidth=1.6;ctx.stroke()});cPts=pts.map((p,i)=>({x:xS(i),y:yS(p.total),date:p.date,total:p.total}));if(sum){const last=pts[pts.length-1];sum.textContent=`${nf.format(last.total)} cumulative through ${ml.format(last.date)}.`}}
function getEl(c){let e=document.querySelector("."+c);if(!e){e=document.createElement("div");e.className=c;e.hidden=true;document.querySelector(".trend-panel")?.appendChild(e)}return e}
function hideTip(){const t=document.querySelector(".chart-tooltip"),m=document.querySelector(".chart-point-highlight");if(t)t.hidden=true;if(m)m.hidden=true}
function initChartMouse(){if(cReady)return;const c=document.getElementById("monthlyLossChart");if(!c)return;c.addEventListener("pointermove",onChart);c.addEventListener("pointerdown",onChart);c.addEventListener("pointerleave",hideTip);cReady=true}
function onChart(e){const c=e.currentTarget;if(!c||!cPts.length){hideTip();return}const rect=c.getBoundingClientRect(),x=e.clientX-rect.left;if(x<0||x>rect.width){hideTip();return}const near=cPts.reduce((b,p)=>Math.abs(p.x-x)<Math.abs(b.x-x)?p:b,cPts[0]);const panel=c.closest(".trend-panel"),tip=getEl("chart-tooltip"),dot=getEl("chart-point-highlight");if(!panel)return;tip.textContent=`${ml.format(near.date)}: ${nf.format(near.total)}`;tip.hidden=false;const pr=panel.getBoundingClientRect(),hw=tip.offsetWidth/2;tip.style.left=`${Math.min(pr.width-8-hw,Math.max(8+hw,rect.left-pr.left+x))}px`;tip.style.top=`${rect.top-pr.top+near.y}px`;dot.hidden=false;dot.style.left=`${rect.left-pr.left+near.x}px`;dot.style.top=`${rect.top-pr.top+near.y}px`}

/* ── Utils ─── */
function parseDate(v){if(typeof v==="string"){let m=v.match(/^(\d{4})-(\d{2})-(\d{2})/);if(m)return new Date(+m[1],+m[2]-1,+m[3]);m=v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);if(m)return new Date(+m[3],+m[1]-1,+m[2])}const d=new Date(v);return isNaN(d.getTime())?BASELINE:d}
function n(v){const x=Number(v);return isFinite(x)?x:0}
function esc(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
function safeUrl(u){if(!u)return"";try{const p=new URL(u,location.href);return/^https?:$/.test(p.protocol)?p.toString():""}catch{return""}}
function inferSrc(u){if(!u)return"Source";try{const h=new URL(u).hostname;if(h.includes("apnews"))return"AP";if(h.includes("cnbc"))return"CNBC";if(h.includes("reuters"))return"Reuters";return h.replace("www.","")}catch{return"Source"}}
function setText(id,t){const el=document.getElementById(id);if(el)el.textContent=t}
</script>
</body>
</html>
