<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reports — Admin</title>
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{--seaweed:#2c4a2a;--green:#3d6b35;--green-bg:#f4f7f2;--border:#d6d6c8;--text:#1a1a1a;--text-mid:#4a4a40;--text-dim:#8a8a7a;--bg:#fff;--shadow-sm:0 1px 3px rgba(0,0,0,.06)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Libre Franklin',system-ui,sans-serif;background:#f5f4ef;color:var(--text);min-height:100vh}
    .login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--seaweed)}
    .login-box{background:var(--bg);padding:2rem;border-radius:.75rem;width:min(380px,90vw);text-align:center}
    .login-box h1{font-size:1.1rem;margin-bottom:1rem;color:var(--seaweed)}
    .login-box input{width:100%;padding:.6rem .8rem;border:1px solid var(--border);border-radius:.4rem;font:inherit;font-size:.9rem;margin-bottom:.75rem}
    .login-error{color:#b33;font-size:.82rem;margin-top:.5rem;min-height:1.2em}
    .topbar{background:var(--seaweed);color:#fff;padding:.6rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    .topbar h1{font-size:.95rem;font-weight:700}
    .topbar-left{display:flex;align-items:center;gap:.6rem}
    .topbar-right{display:flex;align-items:center;gap:.5rem}
    .topbar-nav{display:flex;gap:0;margin-left:1.5rem}
    .topbar-nav a{padding:.35rem .85rem;font-size:.82rem;font-weight:600;color:rgba(255,255,255,.6);text-decoration:none;border-radius:.35rem;transition:all .15s}
    .topbar-nav a:hover{color:#fff;background:rgba(255,255,255,.1)}
    .topbar-nav a.active{color:#fff;background:rgba(255,255,255,.18)}
    .admin-app{display:none}.admin-app.active{display:block}
    .container{width:min(1200px,96vw);margin:1.5rem auto;padding:0 .5rem}
    .btn{display:inline-flex;align-items:center;gap:.3rem;padding:.45rem .9rem;border:1px solid var(--border);border-radius:.4rem;background:var(--bg);font:inherit;font-size:.82rem;font-weight:600;cursor:pointer;color:var(--text-mid);transition:all .15s;text-decoration:none}
    .btn:hover{border-color:var(--green);color:var(--green)}
    .btn-primary{background:var(--seaweed);color:#fff;border-color:var(--seaweed)}
    .btn-primary:hover{background:var(--green)}
    .btn-danger{color:#b33;border-color:#daa}.btn-danger:hover{background:#fef0f0;color:#900}
    .topbar-btn{color:#fff!important;border-color:rgba(255,255,255,.35);background:transparent}.topbar-btn:hover{background:rgba(255,255,255,.12);color:#fff!important;border-color:rgba(255,255,255,.5)}
    .btn-sm{padding:.25rem .55rem;font-size:.75rem}
    .btn-icon{width:1.6rem;height:1.6rem;padding:0;justify-content:center;border-radius:.3rem}
    .stats-bar{display:flex;gap:.6rem;margin-bottom:1.2rem;flex-wrap:wrap}
    .stat-chip{padding:.45rem .85rem;border:1px solid var(--border);border-radius:999px;font-size:.82rem;background:var(--bg)}
    .stat-chip strong{font-weight:800;margin-right:.25rem}
    .table-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
    .table-header h2{font-size:1.05rem;font-weight:800;color:var(--seaweed)}
    table{width:100%;border-collapse:collapse}
    thead th{text-align:left;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--text-dim);padding:.6rem .75rem;border-bottom:2px solid var(--border)}
    tbody td{padding:.7rem .75rem;border-bottom:1px solid #eee;font-size:.88rem;vertical-align:middle}
    tbody tr:hover{background:var(--green-bg)}
    .attr-tag{font-size:.66rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;padding:.15rem .45rem;border-radius:999px}
    .attr-tag.explicit{background:#e6f4e6;color:#1a5c1a}
    .attr-tag.blamed{background:#fef0d0;color:#8a6000}
    .attr-tag.mixed{background:#f0f0f0;color:#555}
    .toggle-track{position:relative;width:2.2rem;height:1.25rem;border-radius:999px;border:none;background:#ccc;cursor:pointer;transition:background .2s;vertical-align:middle}
    .toggle-track.on{background:var(--green)}
    .toggle-knob{position:absolute;top:2px;left:2px;width:calc(1.25rem - 4px);height:calc(1.25rem - 4px);border-radius:50%;background:#fff;transition:left .2s;box-shadow:0 1px 2px rgba(0,0,0,.15)}
    .toggle-track.on .toggle-knob{left:calc(2.2rem - 1.25rem + 2px)}
    .source-link{color:var(--green);text-decoration:none;font-weight:600;font-size:.82rem}.source-link:hover{text-decoration:underline}
    .empty-state{text-align:center;padding:2rem;color:var(--text-dim);font-size:.88rem}
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;align-items:center;justify-content:center}
    .modal-backdrop.open{display:flex}
    .modal{background:var(--bg);border-radius:.75rem;padding:1.5rem;width:min(600px,92vw);max-height:90vh;overflow-y:auto;box-shadow:0 8px 30px rgba(0,0,0,.2)}
    .modal h2{font-size:1.05rem;font-weight:800;color:var(--seaweed);margin-bottom:1rem}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem .85rem}
    .form-group label{display:block;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;color:var(--text-dim);margin-bottom:.2rem}
    .form-group input,.form-group select{width:100%;padding:.45rem .6rem;border:1px solid var(--border);border-radius:.4rem;font:inherit;font-size:.85rem}
    .form-group.full{grid-column:1/-1}
    .form-row-check{display:flex;align-items:center;gap:.4rem;padding-top:.5rem}
    .form-row-check input[type=checkbox]{width:1rem;height:1rem}
    .form-row-check label{font-size:.85rem;text-transform:none;letter-spacing:0;color:var(--text)}
    .form-actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:1rem;padding-top:.75rem;border-top:1px solid var(--border)}
    .toast-container{position:fixed;bottom:1.5rem;right:1.5rem;z-index:300;display:flex;flex-direction:column;gap:.4rem}
    .toast{padding:.6rem 1rem;border-radius:.5rem;background:var(--seaweed);color:#fff;font-size:.84rem;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:opacity .3s}
    .toast.error{background:#b33}
  </style>
</head>
<body>
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <h1>AI Job Tracker — Admin</h1>
    <form id="loginForm"><input type="password" id="loginPassword" placeholder="Enter admin password" autocomplete="current-password" /><button type="submit" class="btn btn-primary" style="width:100%">Sign in</button></form>
    <p class="login-error" id="loginError"></p>
  </div>
</div>
<div class="admin-app" id="app">
  <nav class="topbar">
    <div class="topbar-left">
      <h1>AI Job Tracker</h1>
      <nav class="topbar-nav">
        <a href="/admin" class="active">Reports</a>
        <a href="/admin/candidates" id="candLink">Candidates</a>
      </nav>
    </div>
    <div class="topbar-right">
      <a href="/" class="btn btn-sm" target="_blank" class="btn btn-sm topbar-btn">Dashboard ↗</a>
      <button class="btn btn-sm" id="logoutBtn" class="btn btn-sm topbar-btn">Sign out</button>
    </div>
  </nav>
  <div class="container">
    <div class="stats-bar">
      <div class="stat-chip"><strong id="statTotal">0</strong> total</div>
      <div class="stat-chip"><strong id="statPublished">0</strong> published</div>
      <div class="stat-chip"><strong id="statDraft">0</strong> drafts</div>
    </div>
    <div class="table-header"><h2>All Reports</h2><button class="btn btn-primary" id="addBtn">+ Add Report</button></div>
    <table>
      <thead><tr><th>Date</th><th>Company</th><th>Jobs Lost</th><th>Attribution</th><th>Industry</th><th style="text-align:right">Actions</th></tr></thead>
      <tbody id="reportsList"></tbody>
    </table>
  </div>
</div>
<div class="modal-backdrop" id="modal">
  <div class="modal" role="dialog">
    <h2 id="modalTitle">Add Report</h2>
    <form id="reportForm">
      <input type="hidden" id="fId" />
      <div class="form-grid">
        <div class="form-group"><label for="fDate">Date *</label><input type="date" id="fDate" required /></div>
        <div class="form-group"><label for="fCompany">Company *</label><input type="text" id="fCompany" required placeholder="e.g. Amazon" /></div>
        <div class="form-group"><label for="fJobsLost">Jobs Lost *</label><input type="number" id="fJobsLost" required min="1" placeholder="e.g. 14000" /></div>
        <div class="form-group"><label for="fAttribution">AI Attribution *</label><select id="fAttribution"><option value="EXPLICIT">EXPLICIT</option><option value="BLAMED" selected>BLAMED</option><option value="MIXED">MIXED</option></select></div>
        <div class="form-group"><label for="fIndustry">Industry</label><input type="text" id="fIndustry" placeholder="e.g. Technology" /></div>
        <div class="form-group"><label for="fRegion">Region</label><select id="fRegion"><option value="US">US</option><option value="INTL">International</option><option value="GLOBAL" selected>Global</option></select></div>
        <div class="form-group"><label for="fCountry">Country</label><input type="text" id="fCountry" placeholder="e.g. United States" /></div>
        <div class="form-group"><label for="fWorkforce">Total Workforce</label><input type="number" id="fWorkforce" min="0" placeholder="optional" /></div>
        <div class="form-group"><label for="fSourceLabel">Source</label><input type="text" id="fSourceLabel" placeholder="e.g. AP, CNBC, Reuters" /></div>
        <div class="form-group"><label for="fStockDelta">Stock Δ %</label><input type="number" id="fStockDelta" step="0.01" placeholder="optional" /></div>
        <div class="form-group full"><label for="fSourceUrl">Source URL</label><input type="url" id="fSourceUrl" placeholder="https://..." /></div>
        <div class="form-group"><div class="form-row-check"><input type="checkbox" id="fEstimate" /><label for="fEstimate">Number is an estimate</label></div></div>
        <div class="form-group"><div class="form-row-check"><input type="checkbox" id="fInclude" /><label for="fInclude">Publish to dashboard</label></div></div>
      </div>
      <div class="form-actions"><button type="button" class="btn" id="cancelBtn">Cancel</button><button type="submit" class="btn btn-primary" id="saveBtn">Save Report</button></div>
    </form>
  </div>
</div>
<div class="toast-container" id="toasts"></div>
<script>
const $=id=>document.getElementById(id);
const dateFmt=d=>d?new Date(d+"T00:00:00").toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"—";
const numFmt=new Intl.NumberFormat("en-US");
let reports=[];

async function checkAuth(){try{const r=await fetch("/api/auth/check");const d=await r.json();if(d.authenticated){showApp();return}}catch{}showLogin()}
function showLogin(){$("loginScreen").style.display="flex";$("app").classList.remove("active")}
function showApp(){$("loginScreen").style.display="none";$("app").classList.add("active");loadReports();loadCandBadge()}

$("loginForm").addEventListener("submit",async e=>{e.preventDefault();$("loginError").textContent="";try{const r=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:$("loginPassword").value})});const d=await r.json();if(d.ok)showApp();else $("loginError").textContent=d.error||"Login failed"}catch{$("loginError").textContent="Connection error"}});
$("logoutBtn").addEventListener("click",async()=>{await fetch("/api/logout",{method:"POST"});showLogin();$("loginPassword").value=""});

async function loadCandBadge(){try{const r=await fetch("/api/admin/candidates");if(!r.ok)return;const d=await r.json();const p=d.stats?.pending||0;const link=$("candLink");if(p>0)link.textContent="Candidates ("+p+")";else link.textContent="Candidates"}catch{}}

async function loadReports(){try{const r=await fetch("/api/admin/reports");if(r.status===401){showLogin();return}const d=await r.json();reports=d.reports||[];if(d.stats){$("statTotal").textContent=d.stats.total;$("statPublished").textContent=d.stats.published;$("statDraft").textContent=d.stats.draft}renderTable()}catch{toast("Failed to load reports",true)}}

function renderTable(){const tb=$("reportsList");if(!reports.length){tb.innerHTML='<tr><td colspan="6" class="empty-state">No reports yet.</td></tr>';return}
tb.innerHTML=reports.map(r=>{const attr=(r.aiAttribution||"MIXED").toLowerCase();const tc=attr==="explicit"?"explicit":attr==="blamed"?"blamed":"mixed";return`<tr><td style="white-space:nowrap">${dateFmt(r.date)}</td><td><strong>${esc(r.company)}</strong></td><td>${r.estimate?"~":""}${numFmt.format(r.jobsLost)}</td><td><span class="attr-tag ${tc}">${attr}</span></td><td>${esc(r.industry||"")}</td><td style="text-align:right;white-space:nowrap"><button class="btn btn-sm btn-icon" onclick="editReport(${r.id})" title="Edit">✎</button> <button class="btn btn-sm btn-icon btn-danger" onclick="deleteReport(${r.id})" title="Delete">✕</button> <button class="toggle-track ${r.include?"on":""}" onclick="togglePub(${r.id})" title="${r.include?"Published":"Draft"}"><span class="toggle-knob"></span></button></td></tr>`}).join("")}

window.togglePub=async function(id){try{const r=await fetch("/api/admin/reports/"+id+"/toggle",{method:"PATCH"});if(r.status===401){showLogin();return}const d=await r.json();if(d.ok)loadReports()}catch{toast("Toggle failed",true)}};

function openModal(report){$("modalTitle").textContent=report?"Edit Report":"Add Report";$("saveBtn").textContent=report?"Update":"Save";$("fId").value=report?report.id:"";$("fDate").value=report?report.date:new Date().toISOString().slice(0,10);$("fCompany").value=report?report.company:"";$("fJobsLost").value=report?report.jobsLost:"";$("fAttribution").value=report?report.aiAttribution:"BLAMED";$("fIndustry").value=report?report.industry||"":"";$("fRegion").value=report?report.region:"GLOBAL";$("fCountry").value=report?report.country||"":"";$("fWorkforce").value=report?(report.workforce||""):"";$("fSourceLabel").value=report?report.sourceLabel||"":"";$("fSourceUrl").value=report?report.sourceUrl||"":"";$("fStockDelta").value=report?(report.stockDeltaPct??""):"";$("fEstimate").checked=report?report.estimate:false;$("fInclude").checked=report?report.include:false;$("modal").classList.add("open");$("fCompany").focus()}
function closeModal(){$("modal").classList.remove("open")}
$("addBtn").addEventListener("click",()=>openModal(null));$("cancelBtn").addEventListener("click",closeModal);$("modal").addEventListener("click",e=>{if(e.target===$("modal"))closeModal()});
document.addEventListener("keydown",e=>{if(e.key==="Escape")closeModal()});
window.editReport=function(id){const r=reports.find(x=>x.id===id);if(r)openModal(r)};
$("reportForm").addEventListener("submit",async e=>{e.preventDefault();const id=$("fId").value;const body={date:$("fDate").value,company:$("fCompany").value,jobs_lost:$("fJobsLost").value,ai_attribution:$("fAttribution").value,industry:$("fIndustry").value||"Unknown",region:$("fRegion").value,country:$("fCountry").value||"Global",workforce:$("fWorkforce").value||0,source_label:$("fSourceLabel").value,source_url:$("fSourceUrl").value,stock_delta_pct:$("fStockDelta").value||null,estimate:$("fEstimate").checked,include:$("fInclude").checked,loss_type:"NEW"};try{const method=id?"PUT":"POST";const url=id?"/api/admin/reports/"+id:"/api/admin/reports";const r=await fetch(url,{method,headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});if(r.status===401){showLogin();return}const d=await r.json();if(d.ok){closeModal();toast(id?"Updated":"Added");loadReports()}else toast(d.error||"Failed",true)}catch{toast("Failed",true)}});
window.deleteReport=async function(id){const r=reports.find(x=>x.id===id);if(!confirm("Delete "+r?.company+"?"))return;try{const resp=await fetch("/api/admin/reports/"+id,{method:"DELETE"});if(resp.status===401){showLogin();return}const d=await resp.json();if(d.ok){toast("Deleted");loadReports()}}catch{toast("Failed",true)}};

function toast(msg,err){const t=document.createElement("div");t.className="toast"+(err?" error":"");t.textContent=msg;$("toasts").appendChild(t);setTimeout(()=>{t.style.opacity="0";setTimeout(()=>t.remove(),300)},2800)}
function esc(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}
checkAuth();
</script>
</body>
</html>
