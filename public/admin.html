<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin — AI Job Loss Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
<style>
:root {
  --bg: #0f140d;
  --bg-card: #171d14;
  --bg-card-hover: #1e261a;
  --bg-input: #111610;
  --border: #2a3526;
  --border-focus: #709663;
  --seaweed: #192d17;
  --gamboge: #e4991b;
  --gamboge-dim: #c07f10;
  --green: #709663;
  --green-bright: #8ab87a;
  --ink: #e8ede5;
  --ink-mid: #a3b39c;
  --ink-dim: #6b7a64;
  --red: #c85a4a;
  --red-dim: #3a1c17;
}
* { box-sizing: border-box; margin: 0; }
html { height: 100%; }
body {
  font-family: "Libre Franklin", system-ui, sans-serif;
  background: var(--bg);
  color: var(--ink);
  min-height: 100%;
  line-height: 1.5;
}

/* Login */
.login-screen {
  display: flex; align-items: center; justify-content: center; min-height: 100vh;
  background: radial-gradient(circle at 50% 40%, rgba(112,150,99,0.12), transparent 60%), var(--bg);
}
.login-box {
  width: min(380px, 90vw); padding: 2.2rem; border-radius: 1rem;
  border: 1px solid var(--border); background: var(--bg-card);
}
.login-box img { display: block; margin: 0 auto 1.2rem; width: 180px; height: auto; opacity: 0.7; }
.login-box h1 { text-align: center; font-size: 1.1rem; font-weight: 700; margin-bottom: 1.4rem; color: var(--ink-mid); }
.login-box input {
  width: 100%; padding: 0.7rem 0.85rem; border-radius: 0.5rem;
  border: 1px solid var(--border); background: var(--bg-input); color: var(--ink);
  font-size: 0.95rem; font-family: inherit; outline: none; transition: border-color 0.2s;
}
.login-box input:focus { border-color: var(--border-focus); }
.login-box button { margin-top: 0.85rem; }
.login-error { color: var(--red); font-size: 0.82rem; margin-top: 0.5rem; text-align: center; min-height: 1.2em; }

/* Layout */
.app { display: none; }
.app.active { display: block; }
.topbar {
  display: flex; align-items: center; justify-content: space-between; gap: 1rem;
  padding: 0.85rem 1.5rem; border-bottom: 1px solid var(--border); background: var(--bg-card);
  position: sticky; top: 0; z-index: 100;
}
.topbar-left { display: flex; align-items: center; gap: 0.75rem; }
.topbar img { height: 1.6rem; width: auto; opacity: 0.6; }
.topbar h1 { font-size: 0.92rem; font-weight: 700; color: var(--ink-mid); }
.topbar-right { display: flex; align-items: center; gap: 0.65rem; }
.container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

/* Buttons */
.btn {
  display: inline-flex; align-items: center; gap: 0.4rem;
  padding: 0.55rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border);
  background: var(--bg-card); color: var(--ink); font-family: inherit;
  font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.15s;
  white-space: nowrap;
}
.btn:hover { background: var(--bg-card-hover); border-color: var(--green); }
.btn-primary { background: var(--gamboge); border-color: var(--gamboge); color: #111; }
.btn-primary:hover { background: var(--gamboge-dim); }
.btn-danger { color: var(--red); }
.btn-danger:hover { background: var(--red-dim); border-color: var(--red); }
.btn-sm { padding: 0.35rem 0.65rem; font-size: 0.78rem; }
.btn-icon { padding: 0.35rem 0.5rem; font-size: 1rem; line-height: 1; }

/* Stats bar */
.stats-bar { display: flex; gap: 1rem; margin-bottom: 1.2rem; flex-wrap: wrap; }
.stat-chip {
  padding: 0.55rem 1rem; border-radius: 0.6rem; border: 1px solid var(--border);
  background: var(--bg-card); font-size: 0.82rem; color: var(--ink-mid);
}
.stat-chip strong { color: var(--ink); font-weight: 800; font-size: 1.05rem; margin-right: 0.3rem; }

/* Table */
.table-section { border: 1px solid var(--border); border-radius: 0.75rem; overflow: hidden; background: var(--bg-card); }
.table-header {
  display: flex; align-items: center; justify-content: space-between; gap: 1rem;
  padding: 0.85rem 1rem; border-bottom: 1px solid var(--border);
}
.table-header h2 { font-size: 0.95rem; font-weight: 700; }
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; min-width: 900px; }
thead th {
  text-align: left; padding: 0.6rem 0.7rem; font-size: 0.72rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.06em; color: var(--ink-dim);
  background: rgba(112,150,99,0.08); border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
tbody td {
  padding: 0.6rem 0.7rem; border-bottom: 1px solid rgba(42,53,38,0.5);
  font-size: 0.88rem; vertical-align: middle;
}
tbody tr { transition: background 0.1s; }
tbody tr:hover { background: rgba(112,150,99,0.06); }

/* Publish toggle */
.toggle-track {
  position: relative; width: 2.6rem; height: 1.4rem; border-radius: 999px;
  background: var(--border); cursor: pointer; transition: background 0.2s;
  border: none; padding: 0;
}
.toggle-track.on { background: var(--green); }
.toggle-knob {
  position: absolute; top: 2px; left: 2px; width: 1rem; height: 1rem;
  border-radius: 50%; background: #fff; transition: transform 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.toggle-track.on .toggle-knob { transform: translateX(1.2rem); }

/* Tags */
.tag {
  display: inline-block; font-size: 0.66rem; font-weight: 700; letter-spacing: 0.04em;
  text-transform: uppercase; padding: 0.12rem 0.4rem; border-radius: 999px;
}
.tag-explicit { background: rgba(112,150,99,0.24); color: var(--green-bright); border: 1px solid rgba(112,150,99,0.5); }
.tag-blamed { background: rgba(228,153,27,0.2); color: #f9ddb2; border: 1px solid rgba(228,153,27,0.5); }
.tag-mixed { background: rgba(255,255,255,0.06); color: var(--ink-dim); border: 1px solid rgba(255,255,255,0.15); }

/* Modal */
.modal-backdrop {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.65); backdrop-filter: blur(4px);
  align-items: flex-start; justify-content: center; padding-top: 6vh;
  overflow-y: auto;
}
.modal-backdrop.open { display: flex; }
.modal {
  width: min(560px, 92vw); border-radius: 1rem; border: 1px solid var(--border);
  background: var(--bg-card); padding: 1.6rem; margin-bottom: 2rem;
  animation: modalIn 0.2s ease-out;
}
@keyframes modalIn { from { opacity: 0; transform: translateY(-12px); } }
.modal h2 { font-size: 1.1rem; margin-bottom: 1.2rem; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.85rem; }
.form-group { display: flex; flex-direction: column; gap: 0.3rem; }
.form-group.full { grid-column: 1 / -1; }
.form-group label { font-size: 0.78rem; font-weight: 600; color: var(--ink-mid); }
.form-group input, .form-group select {
  padding: 0.55rem 0.7rem; border-radius: 0.45rem; border: 1px solid var(--border);
  background: var(--bg-input); color: var(--ink); font-family: inherit; font-size: 0.88rem;
  outline: none; transition: border-color 0.2s;
}
.form-group input:focus, .form-group select:focus { border-color: var(--border-focus); }
.form-group select { cursor: pointer; }
.form-group select option { background: var(--bg-card); }
.form-actions { display: flex; gap: 0.65rem; justify-content: flex-end; margin-top: 1.2rem; padding-top: 1rem; border-top: 1px solid var(--border); }
.form-row-check { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.3rem; }
.form-row-check input[type="checkbox"] { width: 1rem; height: 1rem; accent-color: var(--green); cursor: pointer; }

/* Toast */
.toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 300; display: flex; flex-direction: column; gap: 0.5rem; }
.toast {
  padding: 0.65rem 1rem; border-radius: 0.55rem; font-size: 0.85rem; font-weight: 600;
  background: var(--bg-card); border: 1px solid var(--green); color: var(--green-bright);
  box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.4);
  animation: toastIn 0.25s ease-out;
}
.toast.error { border-color: var(--red); color: var(--red); }
@keyframes toastIn { from { opacity: 0; transform: translateY(8px); } }

.empty-state { text-align: center; padding: 3rem 1rem; color: var(--ink-dim); }

@media (max-width: 640px) {
  .form-grid { grid-template-columns: 1fr; }
  .stats-bar { flex-direction: column; }
  .topbar { flex-wrap: wrap; }
}
</style>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <img src="/assets/the-alliance-logo-white-1600.png" alt="The Alliance for Secure AI" />
    <h1>AI Job Tracker — Admin</h1>
    <form id="loginForm">
      <input type="password" id="loginPassword" placeholder="Enter admin password" autocomplete="current-password" />
      <button type="submit" class="btn btn-primary" style="width:100%">Sign in</button>
    </form>
    <p class="login-error" id="loginError"></p>
  </div>
</div>

<!-- App -->
<div class="app" id="app">
  <nav class="topbar">
    <div class="topbar-left">
      <img src="/assets/the-alliance-shield-white-256.png" alt="" />
      <h1>AI Job Tracker Admin</h1>
    </div>
    <div class="topbar-right">
      <a href="/" class="btn btn-sm" target="_blank">View Dashboard ↗</a>
      <button class="btn btn-sm btn-danger" id="logoutBtn">Sign out</button>
    </div>
  </nav>

  <div class="container">
    <!-- Stats -->
    <div class="stats-bar" id="statsBar">
      <div class="stat-chip"><strong id="statTotal">0</strong> total reports</div>
      <div class="stat-chip"><strong id="statPublished">0</strong> published</div>
      <div class="stat-chip"><strong id="statDraft">0</strong> drafts</div>
    </div>

    <!-- Reports Table -->
    <div class="table-section">
      <div class="table-header">
        <h2>All Reports</h2>
        <button class="btn btn-primary" id="addBtn">+ Add Report</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Published</th>
              <th>Date</th>
              <th>Company</th>
              <th>Jobs Lost</th>
              <th>Attribution</th>
              <th>Industry</th>
              <th>Source</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="reportsList"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h2 id="modalTitle">Add Report</h2>
    <form id="reportForm">
      <input type="hidden" id="fId" />
      <div class="form-grid">
        <div class="form-group">
          <label for="fDate">Date *</label>
          <input type="date" id="fDate" required />
        </div>
        <div class="form-group">
          <label for="fCompany">Company *</label>
          <input type="text" id="fCompany" required placeholder="e.g. Amazon" />
        </div>
        <div class="form-group">
          <label for="fJobsLost">Jobs Lost *</label>
          <input type="number" id="fJobsLost" required min="1" placeholder="e.g. 14000" />
        </div>
        <div class="form-group">
          <label for="fAttribution">AI Attribution *</label>
          <select id="fAttribution">
            <option value="EXPLICIT">EXPLICIT — company cited AI</option>
            <option value="BLAMED" selected>BLAMED — reporting cites AI</option>
            <option value="MIXED">MIXED — AI + other factors</option>
          </select>
        </div>
        <div class="form-group">
          <label for="fIndustry">Industry</label>
          <input type="text" id="fIndustry" placeholder="e.g. Technology" />
        </div>
        <div class="form-group">
          <label for="fRegion">Region</label>
          <select id="fRegion">
            <option value="US">US</option>
            <option value="INTL">International</option>
            <option value="GLOBAL" selected>Global</option>
          </select>
        </div>
        <div class="form-group">
          <label for="fCountry">Country</label>
          <input type="text" id="fCountry" placeholder="e.g. United States" />
        </div>
        <div class="form-group">
          <label for="fWorkforce">Total Workforce</label>
          <input type="number" id="fWorkforce" min="0" placeholder="optional" />
        </div>
        <div class="form-group">
          <label for="fSourceLabel">Source</label>
          <input type="text" id="fSourceLabel" placeholder="e.g. AP, CNBC, Reuters" />
        </div>
        <div class="form-group">
          <label for="fStockDelta">Stock Δ %</label>
          <input type="number" id="fStockDelta" step="0.01" placeholder="optional" />
        </div>
        <div class="form-group full">
          <label for="fSourceUrl">Source URL</label>
          <input type="url" id="fSourceUrl" placeholder="https://..." />
        </div>
        <div class="form-group">
          <div class="form-row-check">
            <input type="checkbox" id="fEstimate" />
            <label for="fEstimate">Number is an estimate</label>
          </div>
        </div>
        <div class="form-group">
          <div class="form-row-check">
            <input type="checkbox" id="fInclude" />
            <label for="fInclude">Publish to dashboard</label>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" id="cancelBtn">Cancel</button>
        <button type="submit" class="btn btn-primary" id="saveBtn">Save Report</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toasts"></div>

<script>
const $ = id => document.getElementById(id);
const dateFmt = d => d ? new Date(d + "T00:00:00").toLocaleDateString("en-US", { year:"numeric", month:"short", day:"numeric" }) : "—";
const numFmt = new Intl.NumberFormat("en-US");

let reports = [];

// ── Auth ─────────────────────────────────────────────────────────────

async function checkAuth() {
  try {
    const r = await fetch("/api/auth/check");
    const d = await r.json();
    if (d.authenticated) { showApp(); return; }
  } catch {}
  showLogin();
}

function showLogin() { $("loginScreen").style.display = "flex"; $("app").classList.remove("active"); }
function showApp() { $("loginScreen").style.display = "none"; $("app").classList.add("active"); loadReports(); }

$("loginForm").addEventListener("submit", async e => {
  e.preventDefault();
  $("loginError").textContent = "";
  try {
    const r = await fetch("/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: $("loginPassword").value }),
    });
    const d = await r.json();
    if (d.ok) { showApp(); }
    else { $("loginError").textContent = d.error || "Login failed"; }
  } catch { $("loginError").textContent = "Connection error"; }
});

$("logoutBtn").addEventListener("click", async () => {
  await fetch("/api/logout", { method: "POST" });
  showLogin();
  $("loginPassword").value = "";
});

// ── Load & Render Reports ────────────────────────────────────────────

async function loadReports() {
  try {
    const r = await fetch("/api/admin/reports");
    if (r.status === 401) { showLogin(); return; }
    const d = await r.json();
    reports = d.reports || [];
    renderStats(d.stats);
    renderTable();
  } catch (err) {
    toast("Failed to load reports", true);
  }
}

function renderStats(s) {
  if (!s) return;
  $("statTotal").textContent = s.total;
  $("statPublished").textContent = s.published;
  $("statDraft").textContent = s.draft;
}

function renderTable() {
  const tb = $("reportsList");
  if (!reports.length) {
    tb.innerHTML = '<tr><td colspan="8" class="empty-state">No reports yet. Click "Add Report" to get started.</td></tr>';
    return;
  }
  tb.innerHTML = reports.map(r => {
    const attr = (r.aiAttribution || "MIXED").toLowerCase();
    const tagClass = attr === "explicit" ? "tag-explicit" : attr === "blamed" ? "tag-blamed" : "tag-mixed";
    const srcDomain = r.sourceUrl ? (() => { try { return new URL(r.sourceUrl).hostname.replace("www.",""); } catch { return ""; } })() : "";
    return `<tr data-id="${r.id}">
      <td>
        <button class="toggle-track ${r.include ? "on" : ""}" onclick="togglePub(${r.id})" title="${r.include ? "Published" : "Draft"}">
          <span class="toggle-knob"></span>
        </button>
      </td>
      <td style="white-space:nowrap">${dateFmt(r.date)}</td>
      <td><strong>${esc(r.company)}</strong></td>
      <td>${r.estimate ? "~" : ""}${numFmt.format(r.jobsLost)}</td>
      <td><span class="tag ${tagClass}">${esc(attr)}</span></td>
      <td>${esc(r.industry || "")}</td>
      <td>${r.sourceUrl ? `<a href="${esc(r.sourceUrl)}" target="_blank" rel="noopener" style="color:var(--gamboge);font-size:0.82rem">${esc(r.sourceLabel || srcDomain || "link")}</a>` : esc(r.sourceLabel || "—")}</td>
      <td style="text-align:right;white-space:nowrap">
        <button class="btn btn-sm btn-icon" onclick="editReport(${r.id})" title="Edit">✎</button>
        <button class="btn btn-sm btn-icon btn-danger" onclick="deleteReport(${r.id})" title="Delete">✕</button>
      </td>
    </tr>`;
  }).join("");
}

// ── Toggle Publish ───────────────────────────────────────────────────

async function togglePub(id) {
  try {
    const r = await fetch(`/api/admin/reports/${id}/toggle`, { method: "PATCH" });
    if (r.status === 401) { showLogin(); return; }
    const d = await r.json();
    if (d.ok) {
      const idx = reports.findIndex(x => x.id === id);
      if (idx >= 0) reports[idx] = d.report;
      renderTable();
      toast(d.report.include ? "Published" : "Unpublished");
      refreshStats();
    }
  } catch { toast("Toggle failed", true); }
}
window.togglePub = togglePub;

async function refreshStats() {
  try {
    const r = await fetch("/api/admin/reports");
    const d = await r.json();
    renderStats(d.stats);
  } catch {}
}

// ── Modal ────────────────────────────────────────────────────────────

function openModal(report) {
  $("modalTitle").textContent = report ? "Edit Report" : "Add Report";
  $("saveBtn").textContent = report ? "Update Report" : "Save Report";
  $("fId").value = report ? report.id : "";
  $("fDate").value = report ? report.date : new Date().toISOString().slice(0, 10);
  $("fCompany").value = report ? report.company : "";
  $("fJobsLost").value = report ? report.jobsLost : "";
  $("fAttribution").value = report ? report.aiAttribution : "BLAMED";
  $("fIndustry").value = report ? report.industry || "" : "";
  $("fRegion").value = report ? report.region : "GLOBAL";
  $("fCountry").value = report ? report.country || "" : "";
  $("fWorkforce").value = report ? (report.workforce || "") : "";
  $("fSourceLabel").value = report ? report.sourceLabel || "" : "";
  $("fSourceUrl").value = report ? report.sourceUrl || "" : "";
  $("fStockDelta").value = report ? (report.stockDeltaPct ?? "") : "";
  $("fEstimate").checked = report ? report.estimate : false;
  $("fInclude").checked = report ? report.include : false;
  $("modal").classList.add("open");
  $("fCompany").focus();
}

function closeModal() { $("modal").classList.remove("open"); }

$("addBtn").addEventListener("click", () => openModal(null));
$("cancelBtn").addEventListener("click", closeModal);
$("modal").addEventListener("click", e => { if (e.target === $("modal")) closeModal(); });
document.addEventListener("keydown", e => { if (e.key === "Escape") closeModal(); });

window.editReport = function(id) {
  const r = reports.find(x => x.id === id);
  if (r) openModal(r);
};

// ── Save Report ──────────────────────────────────────────────────────

$("reportForm").addEventListener("submit", async e => {
  e.preventDefault();
  const id = $("fId").value;
  const body = {
    date: $("fDate").value,
    company: $("fCompany").value,
    jobs_lost: $("fJobsLost").value,
    ai_attribution: $("fAttribution").value,
    industry: $("fIndustry").value || "Unknown",
    region: $("fRegion").value,
    country: $("fCountry").value || "Global",
    workforce: $("fWorkforce").value || 0,
    source_label: $("fSourceLabel").value,
    source_url: $("fSourceUrl").value,
    stock_delta_pct: $("fStockDelta").value || null,
    estimate: $("fEstimate").checked,
    include: $("fInclude").checked,
    loss_type: "NEW",
  };

  try {
    const method = id ? "PUT" : "POST";
    const url = id ? `/api/admin/reports/${id}` : "/api/admin/reports";
    const r = await fetch(url, {
      method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(body),
    });
    if (r.status === 401) { showLogin(); return; }
    const d = await r.json();
    if (d.ok) {
      closeModal();
      toast(id ? "Report updated" : "Report added");
      loadReports();
    } else {
      toast(d.error || "Save failed", true);
    }
  } catch { toast("Save failed — connection error", true); }
});

// ── Delete Report ────────────────────────────────────────────────────

window.deleteReport = async function(id) {
  const r = reports.find(x => x.id === id);
  if (!confirm(`Delete "${r?.company || "this report"}"? This cannot be undone.`)) return;
  try {
    const resp = await fetch(`/api/admin/reports/${id}`, { method: "DELETE" });
    if (resp.status === 401) { showLogin(); return; }
    const d = await resp.json();
    if (d.ok) { toast("Deleted"); loadReports(); }
    else toast("Delete failed", true);
  } catch { toast("Delete failed", true); }
};

// ── Toast ────────────────────────────────────────────────────────────

function toast(msg, err) {
  const t = document.createElement("div");
  t.className = "toast" + (err ? " error" : "");
  t.textContent = msg;
  $("toasts").appendChild(t);
  setTimeout(() => { t.style.opacity = "0"; setTimeout(() => t.remove(), 300); }, 2800);
}

// ── Utilities ────────────────────────────────────────────────────────

function esc(s) { return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

// ── Boot ─────────────────────────────────────────────────────────────

checkAuth();
</script>
</body>
</html>
